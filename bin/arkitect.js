#!/usr/bin/env node
import { promises as fs } from "fs";
import { fileURLToPath } from "url";
import path from "path";
import { execSync } from "child_process";

const __dirname = path.dirname(fileURLToPath(import.meta.url));

// Read arkitectâ€™s package.json version
const arkitectPackageJson = JSON.parse(await fs.readFile(path.join(__dirname, "../package.json"), "utf8"));
const arkitectVersion = arkitectPackageJson.version;

const command = process.argv[2];
const arg = process.argv[3];

async function initProject(projectName) {
  const projectDir = path.join(process.cwd(), projectName);
  await fs.mkdir(projectDir, { recursive: true });

  // Override the version in the package.json template
  const packageJsonTemplatePath = path.join(__dirname, "../templates/package.json");
  const packageJsonTemplate = JSON.parse(await fs.readFile(packageJsonTemplatePath, "utf8"));
  packageJsonTemplate.version = arkitectVersion;

  const indexJsxTemplatePath = path.join(__dirname, "../templates/index.jsx");
  const viteConfigTemplatePath = path.join(__dirname, "../templates/vite.config.js");

  const structure = {
    "src": {
      "content": {
        "index.md": await fs.readFile(path.join(__dirname, "../templates/index.md"), "utf8")
      },
      "_data": {
        "nav.json": JSON.stringify([
          { "title": "Home", "url": "/", "icon": "home" }
        ], null, 2),
        "routes.json": JSON.stringify([], null, 2) // Add an empty routes.json file
      },
      "index.jsx": await fs.readFile(indexJsxTemplatePath, "utf8")
    },
    "package.json": JSON.stringify({
      ...packageJsonTemplate,
      name: projectName,
      description: `${projectName} generated by Arkitect`,
      dependencies: {
        ...arkitectPackageJson.peerDependencies,
        "@arthurtsang/arkitect": `^${arkitectVersion}`
      }
    }, null, 2),
    "vite.config.js": await fs.readFile(viteConfigTemplatePath, "utf8")
  };

  async function writeStructure(dir, obj) {
    for (const [key, value] of Object.entries(obj)) {
      const fullPath = path.join(dir, key);
      if (typeof value === "string") {
        await fs.writeFile(fullPath, value);
      } else {
        await fs.mkdir(fullPath, { recursive: true });
        await writeStructure(fullPath, value);
      }
      console.log(`Created: ${fullPath}`);
    }
  }

  await writeStructure(projectDir, structure);

  console.log("Installing dependencies...");
  execSync(`cd ${projectDir} && npm install`, { stdio: "inherit" });
  console.log(`Initialized ${projectDir}. Run 'cd ${projectDir} && npm run build' to get started.`);
}

async function addTemplate(templateName) {
  const templateDir = path.join(__dirname, "../src/templates", templateName);
  const destDir = path.join(process.cwd(), "src/content", templateName);
  await fs.cp(templateDir, destDir, { recursive: true });
  console.log(`Added template ${templateName} to ${destDir}`);

  // Update nav.json with template metadata
  const templateConfigPath = path.join(templateDir, "template.json");
  const navPath = path.join(process.cwd(), "src/_data/nav.json");
  let navData = [];
  try {
    navData = JSON.parse(await fs.readFile(navPath, "utf8"));
  } catch (e) {
    console.log("No existing nav.json, using default.");
  }

  try {
    const templateConfig = JSON.parse(await fs.readFile(templateConfigPath, "utf8"));
    if (templateConfig.nav) {
      if (!navData.some(item => item.url === templateConfig.nav.url)) {
        navData.push(templateConfig.nav);
        await fs.writeFile(navPath, JSON.stringify(navData, null, 2));
        console.log(`Updated nav.json with ${templateName} entry:`, templateConfig.nav);
      } else {
        console.log(`Nav entry for ${templateConfig.nav.url} already exists, skipping.`);
      }
    }
  } catch (e) {
    console.error(`Failed to read or parse ${templateConfigPath}:`, e.message);
  }
}

function runBuild() {
  console.log("Running build...");
  execSync("node " + path.join(__dirname, "../scripts/generate-routes.js"), { stdio: "inherit" });
  console.log("Running Vite build...");
  execSync("vite build", { stdio: "inherit" });
  console.log("Running Eleventy build...");
  execSync(`eleventy --config=${path.join(__dirname, "../.eleventy.js")}`, { stdio: "inherit" });
  console.log("Build complete.");
}

function runStart() {
  console.log("Starting server...");
  execSync("npx serve _site", { stdio: "inherit" });
}

if (command === "init-project" && arg) {
  initProject(arg).catch(console.error);
} else if (command === "add-template" && arg) {
  addTemplate(arg).catch(console.error);
} else if (command === "build") {
  runBuild();
} else if (command === "start") {
  runStart();
} else {
  console.log("Usage: npx @arthurtsang/arkitect [init-project|add-template] <name>");
}